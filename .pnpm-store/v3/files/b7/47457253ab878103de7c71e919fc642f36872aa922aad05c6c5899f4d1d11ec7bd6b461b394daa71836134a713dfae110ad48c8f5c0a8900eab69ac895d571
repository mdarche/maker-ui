{"version":3,"sources":["../../src/maintain/disabled.js"],"names":["context","filter","service","InertSubtree","disengage","makeElementInert","element","undoElementInert","observerConfig","attributes","childList","subtree","attributeFilter","_context","document","documentElement","_filter","_inertElementCache","bind","handleMutation","renderInert","filterElements","filterParentElements","focusable","includeContext","strategy","shadowObserver","config","callback","mutations","forEach","list","map","reduce","previous","current","concat","elements","makeInert","push","isParentOfElement","includeSelf","some","parent","mutation","type","addedElements","addedNodes","nodeType","Node","ELEMENT_NODE","length","addedFocusableElements","listQueryFocusable","target"],"mappings":"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","file":"disabled.js","sourcesContent":["\n/*\n  Utility to make a sub-tree of the DOM inert. Inert means the elements cannot be interacted\n  with and they cannot be focused via script, pointer or keyboard.\n\n  inert attribute was [removed](https://html5.org/r/8536) [tweet by steve](https://twitter.com/stevefaulkner/status/443075900201259008)\n  but definition of [inert subtrees](https://www.w3.org/html/wg/drafts/html/master/editing.html#inert-subtrees) remains.\n\n  [implementation idea by Vasilis](https://codepen.io/vasilisvg/pen/scowI)\n  [inert attribute polyfill by GoogleChrome](https://github.com/GoogleChrome/inert-polyfill)\n\n  [Gecko Bug: Inert Attribute](https://bugzilla.mozilla.org/show_bug.cgi?id=921504)\n  [Chromium Bug: Inert Attribute](https://code.google.com/p/chromium/issues/detail?id=269846)\n  [Chromium Bug: Inert Subtree](https://code.google.com/p/chromium/issues/detail?id=241699)\n  [WebKit Bug: Inert Subtree](https://bugs.webkit.org/show_bug.cgi?id=110952)\n*/\n\nimport nodeArray from '../util/node-array';\nimport queryFocusable from '../query/focusable';\nimport elementDisabled from '../element/disabled';\nimport observeShadowMutations from '../observe/shadow-mutations';\nimport {getParentComparator} from '../util/compare-position';\n\nfunction makeElementInert(element) {\n  return elementDisabled(element, true);\n}\n\nfunction undoElementInert(element) {\n  return elementDisabled(element, false);\n}\n\nconst observerConfig = {\n  attributes: true,\n  childList: true,\n  subtree: true,\n  attributeFilter: ['tabindex', 'disabled', 'data-ally-disabled'],\n};\n\nclass InertSubtree {\n  constructor({context, filter} = {}) {\n    this._context = nodeArray(context || document.documentElement)[0];\n    this._filter = nodeArray(filter);\n    this._inertElementCache = [];\n\n    this.disengage = this.disengage.bind(this);\n    this.handleMutation = this.handleMutation.bind(this);\n    this.renderInert = this.renderInert.bind(this);\n    this.filterElements = this.filterElements.bind(this);\n    this.filterParentElements = this.filterParentElements.bind(this);\n\n    const focusable = queryFocusable({\n      context: this._context,\n      includeContext: true,\n      strategy: 'all',\n    });\n\n    this.renderInert(focusable);\n\n    this.shadowObserver = observeShadowMutations({\n      context: this._context,\n      config: observerConfig,\n      callback: mutations => mutations.forEach(this.handleMutation),\n    });\n  }\n\n  disengage() {\n    if (!this._context) {\n      return;\n    }\n\n    undoElementInert(this._context);\n    this._inertElementCache.forEach((element) => undoElementInert(element));\n\n    this._inertElementCache = null;\n    this._filter = null;\n    this._context = null;\n    this.shadowObserver && this.shadowObserver.disengage();\n    this.shadowObserver = null;\n  }\n\n  listQueryFocusable(list) {\n    return list\n      // find all focusable elements within the given contexts\n      .map(element => queryFocusable({context: element, includeContext: true, strategy: 'all'}))\n      // flatten nested arrays\n      .reduce((previous, current) => previous.concat(current), []);\n  }\n\n  renderInert(elements) {\n    const makeInert = (element) => {\n      this._inertElementCache.push(element);\n      makeElementInert(element);\n    };\n\n    elements\n      .filter(this.filterElements)\n      .filter(this.filterParentElements)\n      // ignore elements that already are disabled\n      // so we don't enable them on disengage()\n      .filter(element => !elementDisabled(element))\n      .forEach(makeInert);\n  }\n\n  filterElements(element) {\n    // ignore elements within the exempted sub-trees\n    const isParentOfElement = getParentComparator({element, includeSelf: true});\n    return !this._filter.some(isParentOfElement);\n  }\n\n  filterParentElements(element) {\n    // ignore ancestors of the exempted sub-trees\n    const isParentOfElement = getParentComparator({parent: element});\n    return !this._filter.some(isParentOfElement);\n  }\n\n  handleMutation(mutation) {\n    if (mutation.type === 'childList') {\n      const addedElements = nodeArray(mutation.addedNodes).filter(element => element.nodeType === Node.ELEMENT_NODE);\n      if (!addedElements.length) {\n        return;\n      }\n\n      const addedFocusableElements = this.listQueryFocusable(addedElements);\n      this.renderInert(addedFocusableElements);\n    } else if (mutation.type === 'attributes') {\n      this.renderInert([mutation.target]);\n    }\n  }\n}\n\nexport default function({context, filter} = {}) {\n  const service = new InertSubtree({context, filter});\n  return { disengage: service.disengage };\n}\n"]}