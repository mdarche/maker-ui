{"version":3,"sources":["../../src/style/focus-within.js"],"names":["addClass","removeClass","shadowFocus","getActiveElements","getParents","decorateService","selectInShadows","_supports","supports","supportsFocusIn","document","focusEventName","blurEventName","className","selector","blurTimer","shadowHandle","applyFocusWithinClass","active","_active","cssShadowPiercingDeepCombinator","slice","_current","call","querySelectorAll","elements","map","context","reduce","previous","current","concat","forEach","element","indexOf","handleDocumentBlurEvent","window","setImmediate","setTimeout","handleDocumentFocusEvent","clearImmediate","clearTimeout","handleShadowFocusEvent","event","detail","disengage","removeEventListener","engage","addEventListener"],"mappings":";AACA;;;;;;;;;AASA,SAASA,QAAT,EAAmBC,WAAnB,QAAsC,sBAAtC;AACA,OAAOC,WAAP,MAAwB,uBAAxB;AACA,OAAOC,iBAAP,MAA8B,wBAA9B;AACA,OAAOC,UAAP,MAAuB,gBAAvB;AACA,OAAOC,eAAP,MAA4B,0BAA5B;AACA,OAAOC,eAAP,MAA4B,2BAA5B;;AAEA,OAAOC,SAAP,MAAsB,sBAAtB;AACA,IAAIC,iBAAJ;;AAEA;AACA,IAAMC,kBAAkB,OAAOC,QAAP,KAAoB,WAApB,IAAmC,eAAeA,QAA1E;AACA,IAAMC,iBAAiBF,kBAAkB,SAAlB,GAA8B,OAArD;AACA,IAAMG,gBAAgBH,kBAAkB,UAAlB,GAA+B,MAArD;;AAEA,IAAMI,YAAY,mBAAlB;AACA;AACA,IAAIC,iBAAJ;AACA,IAAIC,kBAAJ;AACA,IAAIC,qBAAJ;;AAEA,SAASC,qBAAT,CAA+BC,MAA/B,EAAuC;AACrC,MAAIC,UAAUD,UAAUf,mBAAxB;AACA,MAAI,CAACK,SAASY,+BAAd,EAA+C;AAC7C;AACAD,cAAUA,QAAQE,KAAR,CAAc,CAAC,CAAf,CAAV;AACD;;AAED;AACA,MAAMC,WAAW,GAAGD,KAAH,CAASE,IAAT,CAAcb,SAASc,gBAAT,CAA0BV,QAA1B,CAAd,EAAmD,CAAnD,CAAjB;AACA;AACA,MAAMW,WAAWN,QAAQO,GAAR,CAAY,UAACC,OAAD;AAAA,WAAavB,WAAW,EAACuB,gBAAD,EAAX,CAAb;AAAA,GAAZ,EAAgDC,MAAhD,CAAuD,UAASC,QAAT,EAAmBC,OAAnB,EAA4B;AAClG,WAAOA,QAAQC,MAAR,CAAeF,QAAf,CAAP;AACD,GAFgB,EAEd,EAFc,CAAjB;;AAIA;AACAP,WAASU,OAAT,CAAiB,UAASC,OAAT,EAAkB;AACjC,QAAIR,SAASS,OAAT,CAAiBD,OAAjB,MAA8B,CAAC,CAAnC,EAAsC;AACpC;AACD;;AAEDhC,gBAAYgC,OAAZ,EAAqBpB,SAArB;AACD,GAND;;AAQA;AACAY,WAASO,OAAT,CAAiB,UAASC,OAAT,EAAkB;AACjC,QAAIX,SAASY,OAAT,CAAiBD,OAAjB,MAA8B,CAAC,CAAnC,EAAsC;AACpC;AACD;;AAEDjC,aAASiC,OAAT,EAAkBpB,SAAlB;AACD,GAND;AAOD;;AAED,SAASsB,uBAAT,GAAmC;AACjC;AACA;AACApB,cAAY,CAACqB,OAAOC,YAAP,IAAuBD,OAAOE,UAA/B,EAA2C,YAAW;AAChErB;AACD,GAFW,CAAZ;AAGD;;AAED,SAASsB,wBAAT,GAAoC;AAClC;AACA,GAACH,OAAOI,cAAP,IAAyBJ,OAAOK,YAAjC,EAA+C1B,SAA/C;AACA;AACA;AACA;AACA;AACAE;AACD;;AAED,SAASyB,sBAAT,CAAgCC,KAAhC,EAAuC;AACrC1B,wBAAsB0B,MAAMC,MAAN,CAAanB,QAAnC;AACD;;AAED,SAASoB,SAAT,GAAqB;AACnB7B,kBAAgBA,aAAa6B,SAAb,EAAhB;AACA,GAACT,OAAOI,cAAP,IAAyBJ,OAAOK,YAAjC,EAA+C1B,SAA/C;AACAL,WAASoC,mBAAT,CAA6BlC,aAA7B,EAA4CuB,uBAA5C,EAAqE,IAArE;AACAzB,WAASoC,mBAAT,CAA6BnC,cAA7B,EAA6C4B,wBAA7C,EAAuE,IAAvE;AACA7B,WAASoC,mBAAT,CAA6B,cAA7B,EAA6CJ,sBAA7C,EAAqE,IAArE;;AAEA;AACA,KAAGV,OAAH,CAAWT,IAAX,CAAgBb,SAASc,gBAAT,CAA0BV,QAA1B,CAAhB,EAAqD,UAASmB,OAAT,EAAkB;AACrEhC,gBAAYgC,OAAZ,EAAqBpB,SAArB;AACD,GAFD;AAGD;;AAED,SAASkC,MAAT,GAAkB;AAChB,MAAI,CAACvC,QAAL,EAAe;AACbA,eAAWD,WAAX;AACAO,eAAWR,gBAAgB,MAAMO,SAAtB,CAAX;AACD;;AAEDG,iBAAed,aAAf;AACAQ,WAASsC,gBAAT,CAA0BpC,aAA1B,EAAyCuB,uBAAzC,EAAkE,IAAlE;AACAzB,WAASsC,gBAAT,CAA0BrC,cAA1B,EAA0C4B,wBAA1C,EAAoE,IAApE;AACA7B,WAASsC,gBAAT,CAA0B,cAA1B,EAA0CN,sBAA1C,EAAkE,IAAlE;AACAzB;AACD;;AAED,eAAeZ,gBAAgB,EAAE0C,cAAF,EAAUF,oBAAV,EAAhB,CAAf","file":"focus-within.js","sourcesContent":["\n/*\n  add .ally-focus-within class to parents of document.activeElement,\n  to provide the functionality of :focus-within where it's not available\n  see https://dev.w3.org/csswg/selectors-4/#the-focus-within-pseudo\n\n  USAGE:\n    style/focus-within()\n*/\n\nimport { addClass, removeClass } from '../util/toggle-class';\nimport shadowFocus from '../event/shadow-focus';\nimport getActiveElements from '../get/active-elements';\nimport getParents from '../get/parents';\nimport decorateService from '../util/decorate-service';\nimport selectInShadows from '../util/select-in-shadows';\n\nimport _supports from '../supports/supports';\nlet supports;\n\n// preferring focusin/out because they are synchronous in IE10+11\nconst supportsFocusIn = typeof document !== 'undefined' && 'onfocusin' in document;\nconst focusEventName = supportsFocusIn ? 'focusin' : 'focus';\nconst blurEventName = supportsFocusIn ? 'focusout' : 'blur';\n\nconst className = 'ally-focus-within';\n// defined in engage();\nlet selector;\nlet blurTimer;\nlet shadowHandle;\n\nfunction applyFocusWithinClass(active) {\n  let _active = active || getActiveElements();\n  if (!supports.cssShadowPiercingDeepCombinator) {\n    // no shadow-piercing descendant selector, no joy\n    _active = _active.slice(-1);\n  }\n\n  // identify the elements that currently have :focus-within\n  const _current = [].slice.call(document.querySelectorAll(selector), 0);\n  // get the path (ancestry) of each ShadowRoot and merge them into a flat list\n  const elements = _active.map((context) => getParents({context})).reduce(function(previous, current) {\n    return current.concat(previous);\n  }, []);\n\n  // remove the class only from elements that would not receive it again (minimize dom action)\n  _current.forEach(function(element) {\n    if (elements.indexOf(element) !== -1) {\n      return;\n    }\n\n    removeClass(element, className);\n  });\n\n  // apply the class only to elements that do not yet have it (minimize dom action)\n  elements.forEach(function(element) {\n    if (_current.indexOf(element) !== -1) {\n      return;\n    }\n\n    addClass(element, className);\n  });\n}\n\nfunction handleDocumentBlurEvent() {\n  // we won't get a focus for <body>, but a delayed blur handler will achieve\n  // the same thing listening for focus would've done, unless we get a focus, of course\n  blurTimer = (window.setImmediate || window.setTimeout)(function() {\n    applyFocusWithinClass();\n  });\n}\n\nfunction handleDocumentFocusEvent() {\n  // abort any handlers that come from document or element blur handlers\n  (window.clearImmediate || window.clearTimeout)(blurTimer);\n  // NOTE: we could overcome Firefox 34 issue of not supporting ShadowRoot.host by\n  // passing event.target (which references the first-level ShadowHost), but that\n  // would require applyFocusWithinClass() to distinguish between the argument and\n  // getActiveElements().\n  applyFocusWithinClass();\n}\n\nfunction handleShadowFocusEvent(event) {\n  applyFocusWithinClass(event.detail.elements);\n}\n\nfunction disengage() {\n  shadowHandle && shadowHandle.disengage();\n  (window.clearImmediate || window.clearTimeout)(blurTimer);\n  document.removeEventListener(blurEventName, handleDocumentBlurEvent, true);\n  document.removeEventListener(focusEventName, handleDocumentFocusEvent, true);\n  document.removeEventListener('shadow-focus', handleShadowFocusEvent, true);\n\n  // remove any remaining ally-within-focus occurrences\n  [].forEach.call(document.querySelectorAll(selector), function(element) {\n    removeClass(element, className);\n  });\n}\n\nfunction engage() {\n  if (!supports) {\n    supports = _supports();\n    selector = selectInShadows('.' + className);\n  }\n\n  shadowHandle = shadowFocus();\n  document.addEventListener(blurEventName, handleDocumentBlurEvent, true);\n  document.addEventListener(focusEventName, handleDocumentFocusEvent, true);\n  document.addEventListener('shadow-focus', handleShadowFocusEvent, true);\n  applyFocusWithinClass();\n}\n\nexport default decorateService({ engage, disengage });\n"]}