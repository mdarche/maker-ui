{"version":3,"sources":["../../src/style/focus-within.js"],"names":["supports","supportsFocusIn","document","focusEventName","blurEventName","className","selector","blurTimer","shadowHandle","applyFocusWithinClass","active","_active","cssShadowPiercingDeepCombinator","slice","_current","call","querySelectorAll","elements","map","context","reduce","previous","current","concat","forEach","element","indexOf","handleDocumentBlurEvent","window","setImmediate","setTimeout","handleDocumentFocusEvent","clearImmediate","clearTimeout","handleShadowFocusEvent","event","detail","disengage","removeEventListener","engage","addEventListener"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAkBA,MAAIA,iBAAJ;;AAEA;;AAnBA;;;;;;;;;AAoBA,MAAMC,kBAAkB,OAAOC,QAAP,KAAoB,WAApB,IAAmC,eAAeA,QAA1E;AACA,MAAMC,iBAAiBF,kBAAkB,SAAlB,GAA8B,OAArD;AACA,MAAMG,gBAAgBH,kBAAkB,UAAlB,GAA+B,MAArD;;AAEA,MAAMI,YAAY,mBAAlB;AACA;AACA,MAAIC,iBAAJ;AACA,MAAIC,kBAAJ;AACA,MAAIC,qBAAJ;;AAEA,WAASC,qBAAT,CAA+BC,MAA/B,EAAuC;AACrC,QAAIC,UAAUD,UAAU,+BAAxB;AACA,QAAI,CAACV,SAASY,+BAAd,EAA+C;AAC7C;AACAD,gBAAUA,QAAQE,KAAR,CAAc,CAAC,CAAf,CAAV;AACD;;AAED;AACA,QAAMC,WAAW,GAAGD,KAAH,CAASE,IAAT,CAAcb,SAASc,gBAAT,CAA0BV,QAA1B,CAAd,EAAmD,CAAnD,CAAjB;AACA;AACA,QAAMW,WAAWN,QAAQO,GAAR,CAAY,UAACC,OAAD;AAAA,aAAa,uBAAW,EAACA,gBAAD,EAAX,CAAb;AAAA,KAAZ,EAAgDC,MAAhD,CAAuD,UAASC,QAAT,EAAmBC,OAAnB,EAA4B;AAClG,aAAOA,QAAQC,MAAR,CAAeF,QAAf,CAAP;AACD,KAFgB,EAEd,EAFc,CAAjB;;AAIA;AACAP,aAASU,OAAT,CAAiB,UAASC,OAAT,EAAkB;AACjC,UAAIR,SAASS,OAAT,CAAiBD,OAAjB,MAA8B,CAAC,CAAnC,EAAsC;AACpC;AACD;;AAED,oCAAYA,OAAZ,EAAqBpB,SAArB;AACD,KAND;;AAQA;AACAY,aAASO,OAAT,CAAiB,UAASC,OAAT,EAAkB;AACjC,UAAIX,SAASY,OAAT,CAAiBD,OAAjB,MAA8B,CAAC,CAAnC,EAAsC;AACpC;AACD;;AAED,iCAASA,OAAT,EAAkBpB,SAAlB;AACD,KAND;AAOD;;AAED,WAASsB,uBAAT,GAAmC;AACjC;AACA;AACApB,gBAAY,CAACqB,OAAOC,YAAP,IAAuBD,OAAOE,UAA/B,EAA2C,YAAW;AAChErB;AACD,KAFW,CAAZ;AAGD;;AAED,WAASsB,wBAAT,GAAoC;AAClC;AACA,KAACH,OAAOI,cAAP,IAAyBJ,OAAOK,YAAjC,EAA+C1B,SAA/C;AACA;AACA;AACA;AACA;AACAE;AACD;;AAED,WAASyB,sBAAT,CAAgCC,KAAhC,EAAuC;AACrC1B,0BAAsB0B,MAAMC,MAAN,CAAanB,QAAnC;AACD;;AAED,WAASoB,SAAT,GAAqB;AACnB7B,oBAAgBA,aAAa6B,SAAb,EAAhB;AACA,KAACT,OAAOI,cAAP,IAAyBJ,OAAOK,YAAjC,EAA+C1B,SAA/C;AACAL,aAASoC,mBAAT,CAA6BlC,aAA7B,EAA4CuB,uBAA5C,EAAqE,IAArE;AACAzB,aAASoC,mBAAT,CAA6BnC,cAA7B,EAA6C4B,wBAA7C,EAAuE,IAAvE;AACA7B,aAASoC,mBAAT,CAA6B,cAA7B,EAA6CJ,sBAA7C,EAAqE,IAArE;;AAEA;AACA,OAAGV,OAAH,CAAWT,IAAX,CAAgBb,SAASc,gBAAT,CAA0BV,QAA1B,CAAhB,EAAqD,UAASmB,OAAT,EAAkB;AACrE,oCAAYA,OAAZ,EAAqBpB,SAArB;AACD,KAFD;AAGD;;AAED,WAASkC,MAAT,GAAkB;AAChB,QAAI,CAACvC,QAAL,EAAe;AACbA,iBAAW,yBAAX;AACAM,iBAAW,+BAAgB,MAAMD,SAAtB,CAAX;AACD;;AAEDG,mBAAe,4BAAf;AACAN,aAASsC,gBAAT,CAA0BpC,aAA1B,EAAyCuB,uBAAzC,EAAkE,IAAlE;AACAzB,aAASsC,gBAAT,CAA0BrC,cAA1B,EAA0C4B,wBAA1C,EAAoE,IAApE;AACA7B,aAASsC,gBAAT,CAA0B,cAA1B,EAA0CN,sBAA1C,EAAkE,IAAlE;AACAzB;AACD;;oBAEc,+BAAgB,EAAE8B,cAAF,EAAUF,oBAAV,EAAhB,C","file":"focus-within.js","sourcesContent":["\n/*\n  add .ally-focus-within class to parents of document.activeElement,\n  to provide the functionality of :focus-within where it's not available\n  see https://dev.w3.org/csswg/selectors-4/#the-focus-within-pseudo\n\n  USAGE:\n    style/focus-within()\n*/\n\nimport { addClass, removeClass } from '../util/toggle-class';\nimport shadowFocus from '../event/shadow-focus';\nimport getActiveElements from '../get/active-elements';\nimport getParents from '../get/parents';\nimport decorateService from '../util/decorate-service';\nimport selectInShadows from '../util/select-in-shadows';\n\nimport _supports from '../supports/supports';\nlet supports;\n\n// preferring focusin/out because they are synchronous in IE10+11\nconst supportsFocusIn = typeof document !== 'undefined' && 'onfocusin' in document;\nconst focusEventName = supportsFocusIn ? 'focusin' : 'focus';\nconst blurEventName = supportsFocusIn ? 'focusout' : 'blur';\n\nconst className = 'ally-focus-within';\n// defined in engage();\nlet selector;\nlet blurTimer;\nlet shadowHandle;\n\nfunction applyFocusWithinClass(active) {\n  let _active = active || getActiveElements();\n  if (!supports.cssShadowPiercingDeepCombinator) {\n    // no shadow-piercing descendant selector, no joy\n    _active = _active.slice(-1);\n  }\n\n  // identify the elements that currently have :focus-within\n  const _current = [].slice.call(document.querySelectorAll(selector), 0);\n  // get the path (ancestry) of each ShadowRoot and merge them into a flat list\n  const elements = _active.map((context) => getParents({context})).reduce(function(previous, current) {\n    return current.concat(previous);\n  }, []);\n\n  // remove the class only from elements that would not receive it again (minimize dom action)\n  _current.forEach(function(element) {\n    if (elements.indexOf(element) !== -1) {\n      return;\n    }\n\n    removeClass(element, className);\n  });\n\n  // apply the class only to elements that do not yet have it (minimize dom action)\n  elements.forEach(function(element) {\n    if (_current.indexOf(element) !== -1) {\n      return;\n    }\n\n    addClass(element, className);\n  });\n}\n\nfunction handleDocumentBlurEvent() {\n  // we won't get a focus for <body>, but a delayed blur handler will achieve\n  // the same thing listening for focus would've done, unless we get a focus, of course\n  blurTimer = (window.setImmediate || window.setTimeout)(function() {\n    applyFocusWithinClass();\n  });\n}\n\nfunction handleDocumentFocusEvent() {\n  // abort any handlers that come from document or element blur handlers\n  (window.clearImmediate || window.clearTimeout)(blurTimer);\n  // NOTE: we could overcome Firefox 34 issue of not supporting ShadowRoot.host by\n  // passing event.target (which references the first-level ShadowHost), but that\n  // would require applyFocusWithinClass() to distinguish between the argument and\n  // getActiveElements().\n  applyFocusWithinClass();\n}\n\nfunction handleShadowFocusEvent(event) {\n  applyFocusWithinClass(event.detail.elements);\n}\n\nfunction disengage() {\n  shadowHandle && shadowHandle.disengage();\n  (window.clearImmediate || window.clearTimeout)(blurTimer);\n  document.removeEventListener(blurEventName, handleDocumentBlurEvent, true);\n  document.removeEventListener(focusEventName, handleDocumentFocusEvent, true);\n  document.removeEventListener('shadow-focus', handleShadowFocusEvent, true);\n\n  // remove any remaining ally-within-focus occurrences\n  [].forEach.call(document.querySelectorAll(selector), function(element) {\n    removeClass(element, className);\n  });\n}\n\nfunction engage() {\n  if (!supports) {\n    supports = _supports();\n    selector = selectInShadows('.' + className);\n  }\n\n  shadowHandle = shadowFocus();\n  document.addEventListener(blurEventName, handleDocumentBlurEvent, true);\n  document.addEventListener(focusEventName, handleDocumentFocusEvent, true);\n  document.addEventListener('shadow-focus', handleShadowFocusEvent, true);\n  applyFocusWithinClass();\n}\n\nexport default decorateService({ engage, disengage });\n"]}