{"version":3,"sources":["../../src/supports/supports-cache.js"],"names":["readLocalStorage","key","data","window","localStorage","getItem","JSON","parse","e","writeLocalStorage","value","document","hasFocus","removeItem","setItem","stringify","userAgent","navigator","cacheKey","cache","version","get","set","values","Object","keys","forEach","time","Date","toISOString"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;AAUA,WAASA,gBAAT,CAA0BC,GAA1B,EAA+B;AAC7B;AACA;AACA,QAAIC,aAAJ;;AAEA,QAAI;AACFA,aAAOC,OAAOC,YAAP,IAAuBD,OAAOC,YAAP,CAAoBC,OAApB,CAA4BJ,GAA5B,CAA9B;AACAC,aAAOA,OAAOI,KAAKC,KAAL,CAAWL,IAAX,CAAP,GAA0B,EAAjC;AACD,KAHD,CAGE,OAAOM,CAAP,EAAU;AACVN,aAAO,EAAP;AACD;;AAED,WAAOA,IAAP;AACD,G,CAvBD;;;;;;;;AAyBA,WAASO,iBAAT,CAA2BR,GAA3B,EAAgCS,KAAhC,EAAuC;AACrC,QAAI,CAACC,SAASC,QAAT,EAAL,EAA0B;AACxB;AACA;AACA;AACA,UAAI;AACFT,eAAOC,YAAP,IAAuBD,OAAOC,YAAP,CAAoBS,UAApB,CAA+BZ,GAA/B,CAAvB;AACD,OAFD,CAEE,OAAOO,CAAP,EAAU;AACV;AACD;;AAED;AACD;;AAED,QAAI;AACFL,aAAOC,YAAP,IAAuBD,OAAOC,YAAP,CAAoBU,OAApB,CAA4Bb,GAA5B,EAAiCK,KAAKS,SAAL,CAAeL,KAAf,CAAjC,CAAvB;AACD,KAFD,CAEE,OAAOF,CAAP,EAAU;AACV;AACD;AACF;;AAED,MAAMQ,YAAY,OAAOb,MAAP,KAAkB,WAAlB,IAAiCA,OAAOc,SAAP,CAAiBD,SAAlD,IAA+D,EAAjF;AACA,MAAME,WAAW,qBAAjB;AACA,MAAIC,QAAQnB,iBAAiBkB,QAAjB,CAAZ;;AAEA;AACA,MAAIC,MAAMH,SAAN,KAAoBA,SAApB,IAAiCG,MAAMC,OAAN,sBAArC,EAAgE;AAC9DD,YAAQ,EAAR;AACD;;AAEDA,QAAMH,SAAN,GAAkBA,SAAlB;AACAG,QAAMC,OAAN;;oBAEe;AACbC,SAAK,eAAW;AACd,aAAOF,KAAP;AACD,KAHY;AAIbG,SAAK,aAASC,MAAT,EAAiB;AACpBC,aAAOC,IAAP,CAAYF,MAAZ,EAAoBG,OAApB,CAA4B,UAASzB,GAAT,EAAc;AACxCkB,cAAMlB,GAAN,IAAasB,OAAOtB,GAAP,CAAb;AACD,OAFD;;AAIAkB,YAAMQ,IAAN,GAAa,IAAIC,IAAJ,GAAWC,WAAX,EAAb;AACApB,wBAAkBS,QAAlB,EAA4BC,KAA5B;AACD;AAXY,G","file":"supports-cache.js","sourcesContent":["/*\n    Facility to cache test results in localStorage.\n\n    USAGE:\n      cache.get('key');\n      cache.set('key', 'value');\n */\n\nimport version from '../version';\n\nfunction readLocalStorage(key) {\n  // allow reading from storage to retrieve previous support results\n  // even while the document does not have focus\n  let data;\n\n  try {\n    data = window.localStorage && window.localStorage.getItem(key);\n    data = data ? JSON.parse(data) : {};\n  } catch (e) {\n    data = {};\n  }\n\n  return data;\n}\n\nfunction writeLocalStorage(key, value) {\n  if (!document.hasFocus()) {\n    // if the document does not have focus when tests are executed, focus() may\n    // not be handled properly and events may not be dispatched immediately.\n    // This can happen when a document is reloaded while Developer Tools have focus.\n    try {\n      window.localStorage && window.localStorage.removeItem(key);\n    } catch (e) {\n      // ignore\n    }\n\n    return;\n  }\n\n  try {\n    window.localStorage && window.localStorage.setItem(key, JSON.stringify(value));\n  } catch (e) {\n    // ignore\n  }\n}\n\nconst userAgent = typeof window !== 'undefined' && window.navigator.userAgent || '';\nconst cacheKey = 'ally-supports-cache';\nlet cache = readLocalStorage(cacheKey);\n\n// update the cache if ally or the user agent changed (newer version, etc)\nif (cache.userAgent !== userAgent || cache.version !== version) {\n  cache = {};\n}\n\ncache.userAgent = userAgent;\ncache.version = version;\n\nexport default {\n  get: function() {\n    return cache;\n  },\n  set: function(values) {\n    Object.keys(values).forEach(function(key) {\n      cache[key] = values[key];\n    });\n\n    cache.time = new Date().toISOString();\n    writeLocalStorage(cacheKey, cache);\n  },\n};\n"]}